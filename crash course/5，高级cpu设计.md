# 高级CPU设计
*现代处理器有上千条指令，有各种巧妙复杂的电路，运算速度极快。*

**RAM成了瓶颈**
> RAM是CPU之外的独立组件，意味着数据要用线来传递——总线（bus），总线可能只有几厘米，电信号的传输接近光速，但是CPU每秒可以处理上亿条指令，很小的延迟也会造成问题。RAM还需要时间找地址，取数据，配置，输出数据，一条“从内存读数据”的指令可能要多个时钟周期，CPU空等数据。

### 提高CPU性能的方法
**缓存（cache)——CPU中内置的内存。**
* 由于cpu中空间很小，所以缓存一般单位都为KB或MB
* > 缓存提高了速度，CPU从RAM拿数据时，RAM不用传一个，可以传一批，虽然花的时间久一点，但是数据可以存在缓存。这很实用因为数据常常是一个个按顺序处理的。因为缓存离CPU近，一个时钟周期就能给数据，所以CPU不需要空等，比起反复去RAM拿数据快得多。
* 如果想要的数据已经在缓存中，称为缓存命中（cache hit），如果想要的数据不在缓存，称为缓存未命中（cache miss）。
* 缓存也可以当临时空间存一些中间值，适合又长又复杂的运算。

**流水线技术（instruction pipelining）——指令的并行处理**
在程序的执行过程（取指令->解码->执行）中每个过程用的是CPU的不同部分，这意味着可以‘并行处理’。即对上一条指令解码的同时可以取下一条指令。
这样就可以在一定的时钟周期内执行更多的指令。
*和缓存一样，这也会带来一些问题*
* 第一个问题是指令之间的依赖关系，例如在读某个数据而正在执行的指令会改变这个数据，也就是说拿的是旧数据。因此流水线处理器需要先弄清楚数据依赖性，必要时停止流水线以避免出问题。高端CPU如笔记本和手机里的那种会更进一步，动态排序有依赖关系的指令，最小化流水线的停工时间，这叫“乱序执行”（out-of-order execution）。这种电路非常复杂，但由于非常高效，几乎所有现代处理器都有流水线。
* 第二个问题是“条件跳转”
  * 跳转指令会改变程序的执行流，简单的流水线处理器在看到 JUMP 指令时会停一会，等待条件值确定下来，一旦 JUMP 的结果出来了，处理器就继续流水线。因为空等会造成延迟，所以高端处理器会用一些技巧，可以把 JUMP 想成是岔路口，高端CPU会猜哪条路的可能性大一些，然后提前把指令放进流水线，这叫“推测执行”（speculative execution）。当 JUMP 的结果出了，如果CPU猜对了，流水线已经塞满正确指令，可以马上运行，如果CPU猜错了，就要清空流水线。
  * 为了尽可能减少清空流水线的次数，CPU厂商开发了复杂的方法，来猜测哪条分支更有可能，叫“分支预测”（branch prediction），现代CPU的正确率超过90%。

理想情况下，流水线一个时钟周期完成1个指令，然后“超标量处理器”出现了，一个时钟周期完成多个指令，即便有流水线设计，在指令执行阶段处理器里有些区域还是可能会空闲，例如在执行一个“从内存取值”指令期间，ALU会闲置，所以一次性处理多条指令（取指令+解码）会更好，如果多条指令要CPU的不同部分，就多条同时执行。我们可以再进一步，加多几个相同的电路执行出现频次很高的指令，比如CPU有四个，八个甚至更多完全相同的ALU，可以同时执行多个数学运算。

**多核处理器——同时运行多个指令流**
> 多核处理器（multi-core processors）是指在一枚处理器中集成两个或多个完整的计算引擎(内核)，此时处理器能支持系统总线上的多个处理器，由总线控制器提供所有总线控制信号和命令信号。

即一个CPU中有多个独立处理单元，像是有多个独立CPU
![fang_pin-thanks.png](https://note.youdao.com/yws/res/5080/WEBRESOURCE2e4161757248b02567e6f8577dc27f4b)
